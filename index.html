<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouDJ - YouTube Looper</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    #player { width: 100%; height: 450px; margin: 20px 0; }
    input, button { padding: 8px; margin: 5px 0; }
    #tap-status { margin: 10px 0; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouDJ</h1>
    <input type="text" id="youtube-url" placeholder="YouTube URL" />
    <button onclick="loadVideo()">Load Video</button>
    <div id="player"></div>
    
    <div>
      <button id="tap-btn" onclick="handleTap()">Tap</button>
      <span id="tap-status">Tap to set start/end time</span>
    </div>
    
    <div>
      <input type="number" id="start-time" placeholder="Start time (sec)" readonly />
      <input type="number" id="end-time" placeholder="End time (sec)" readonly />
      <button onclick="startLoop()">Play Loop</button>
    </div>
  </div>

  <script>
    let player;
    let tapState = 0; // 0 = waiting 1st tap, 1 = waiting 2nd tap
    let startTime = 0;
    let endTime = 0;

    // Загрузка YouTube API
    function loadVideo() {
      const url = document.getElementById('youtube-url').value;
      const videoId = extractVideoId(url);

      if (!player) {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);
        
        window.onYouTubeIframeAPIReady = function() {
          player = new YT.Player('player', {
            videoId: videoId,
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
            }
          });
        };
      } else {
        player.loadVideoById(videoId);
      }
    }

    function onPlayerReady(event) {
      console.log("Player is ready");
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        restartLoop();
      }
    }

    // Обработка нажатия кнопки Tap
    function handleTap() {
      if (!player) return;

      const currentTime = player.getCurrentTime();
      
      if (tapState === 0) {
        // Первый тап - начало отрезка
        startTime = currentTime;
        document.getElementById('start-time').value = startTime;
        document.getElementById('tap-status').textContent = `Start set: ${startTime}s. Tap again for end.`;
        tapState = 1;
      } else {
        // Второй тап - конец отрезка
        endTime = currentTime;
        document.getElementById('end-time').value = endTime;
        document.getElementById('tap-status').textContent = `Loop set: ${startTime}s → ${endTime}s`;
        tapState = 0;
        startLoop();
      }
    }

    // Запуск цикла
    function startLoop() {
      if (!player || startTime >= endTime) return;
      
      player.seekTo(startTime);
      player.playVideo();
    }

    // Перезапуск цикла
    function restartLoop() {
      if (!player) return;
      player.seekTo(startTime);
      player.playVideo();
    }

    // Извлечение ID видео из URL
    function extractVideoId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }
  </script>
</body>
</html>
