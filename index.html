<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouDJ - YouTube Looper</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    #player { width: 100%; height: 450px; margin: 20px 0; }
    input, button { padding: 8px; margin: 5px 0; }
    #tap-status { margin: 10px 0; font-weight: bold; }
    .time-inputs { display: flex; gap: 10px; align-items: center; }
    #loop-btn {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    #loop-btn.looping {
      background-color: #f44336;
    }
    #loop-btn::before {
      content: "▶";
      margin-right: 5px;
    }
    #loop-btn.looping::before {
      content: "∞";
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouDJ</h1>
    <input type="text" id="youtube-url" placeholder="YouTube URL" />
    <button onclick="loadVideo()">Load Video</button>
    <div id="player"></div>
    
    <div>
      <button id="tap-btn" onclick="handleTap()">Tap</button>
      <span id="tap-status">Tap to set start/end time</span>
    </div>
    
    <div class="time-inputs">
      <input type="number" id="start-time" placeholder="Start time (sec)" step="0.1" />
      <input type="number" id="end-time" placeholder="End time (sec)" step="0.1" />
      <button id="loop-btn" onclick="toggleLoop()">Play Loop</button>
    </div>
  </div>

  <script>
    let player;
    let tapState = 0;
    let startTime = 0;
    let endTime = 0;
    let loopInterval;
    let isLooping = false;

    function loadVideo() {
      const url = document.getElementById('youtube-url').value;
      const videoId = extractVideoId(url);

      if (!player) {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);
        
        window.onYouTubeIframeAPIReady = function() {
          player = new YT.Player('player', {
            videoId: videoId,
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
            }
          });
        };
      } else {
        cancelLoop();
        player.loadVideoById(videoId);
      }
    }

    function onPlayerReady(event) {
      console.log("Player is ready");
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && isLooping) {
        checkTimeLoop();
      }
    }

    function checkTimeLoop() {
      if (!player || !isLooping) return;

      const currentTime = player.getCurrentTime();
      if (currentTime >= endTime) {
        player.seekTo(startTime);
        player.playVideo();
      }
    }

    function handleTap() {
      if (!player) return;

      const currentTime = player.getCurrentTime();
      
      if (tapState === 0) {
        startTime = currentTime;
        document.getElementById('start-time').value = startTime.toFixed(1);
        document.getElementById('tap-status').textContent = `Start set: ${startTime.toFixed(1)}s. Tap again for end.`;
        tapState = 1;
      } else {
        endTime = currentTime;
        document.getElementById('end-time').value = endTime.toFixed(1);
        document.getElementById('tap-status').textContent = `Loop set: ${startTime.toFixed(1)}s → ${endTime.toFixed(1)}s`;
        tapState = 0;
      }
    }

    function toggleLoop() {
      if (isLooping) {
        cancelLoop();
      } else {
        startLoop();
      }
    }

    function startLoop() {
      if (!player) return;
      
      startTime = parseFloat(document.getElementById('start-time').value) || 0;
      endTime = parseFloat(document.getElementById('end-time').value) || 0;
      
      if (startTime >= endTime) {
        alert("End time must be greater than start time!");
        return;
      }

      isLooping = true;
      document.getElementById('loop-btn').classList.add('looping');
      
      player.seekTo(startTime);
      player.playVideo();
      
      loopInterval = setInterval(checkTimeLoop, 100);
      document.getElementById('tap-status').textContent = `Looping: ${startTime.toFixed(1)}s → ${endTime.toFixed(1)}s`;
    }

    function cancelLoop() {
      isLooping = false;
      document.getElementById('loop-btn').classList.remove('looping');
      
      if (loopInterval) {
        clearInterval(loopInterval);
        loopInterval = null;
      }
      document.getElementById('tap-status').textContent = "Loop stopped";
    }

    function extractVideoId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }
  </script>
</body>
</html>
